---
title: "Updated flight data"
author: "Francisko de Moraes Rezende"
date: "4/13/2021"
output:
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Motivation

I found a problem with the previous code: I added info on butterfly_flight
to the data before calculating the distances and that makes the paths larger than
they actually are. This version does not have that problem.

I also changed the code in order to use `purrr`, a package for doing functional
programming. Basically, it makes it way easier to maintain the code by making it 
shorter.

I suppose that's enough rambling from me, let's give you the tables, that's what
you want after all `r emo::ji("smile")`

# Data processing

## Loads and installs packages used if needed

```{r}
list_of_packages <- c("tidyverse", "here", "fs", "plotly")
new_packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

library(tidyverse)
library(here)
library(fs)
library(plotly)
```

## Loading files

```{r}
fs::dir_ls(here::here('wand'), recurse = T, regexp = "unpaired-points-xyz.csv$") %>% 
  purrr::map_dfr(readr::read_csv, .id = "source") -> all_flights

all_flights %>% 
  dplyr::distinct(source)
```


## Defining functions

```{r}
calc_flight_dist <- function(dat) {
  dat_dist <-  {{dat}} %>% 
  dplyr::filter(!is.na(x_1)) %>%  # removes NA
  dist() %>%  # calculates distance
  as.matrix()  # converts it to a matrix

return(sum((dat_dist[row(dat_dist) == col(dat_dist) + 1])))  # sums the distance between points by summing the points in line n and column n + 1
  
}
```

```{r}
plots_flight_path <- function(dat) {
  
plotly::plot_ly(data = dat,
        type = "scatter3d", 
        x = dat$x_1 ,
        y = dat$y_1,
        z = dat$z_1,
        mode = "lines")
}
```

```{r}
calc_straight_dist <- function(dat) {
  
dist_dat <- 
  dat %>% 
  dplyr::filter(!is.na(x_1)) %>%
  dist() %>% 
  as.matrix()

return(dist_dat[1, nrow(dist_dat)])  
}

```


```{r}
all_flights %>%
  dplyr::group_by(source) %>%
  tidyr::nest() %>% 
  dplyr::mutate(distance = purrr::map_dbl(data, ~ calc_flight_dist(.x)),
                straight_distance = purrr::map_dbl(data, ~ calc_straight_dist(.x)),
                sinuosity = distance / straight_distance,
                plot_3d = purrr::map(data, ~ plots_flight_path(.x)),
                butterfly = stringr::str_extract(source, pattern = "b\\d{3}"),
                take = stringr::str_extract(source, pattern = "t\\d{1}")) -> processed
```

## Here's the table

```{r}
processed %>% 
  dplyr::ungroup() %>% 
  dplyr::select(butterfly, take, everything(), -source, -data, -plot_3d) %>% 
  DT::datatable(extensions = 'Buttons',
                options = list(dom = 'Blfrtip',
                               buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                               lengthMenu = list(c(10,25,50,-1),
                                                 c(10,25,50,"All"))))
```

